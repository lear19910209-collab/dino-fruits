<!doctype html>
<html lang="zh">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>小恐龙躲水果 · 像素风 · 关卡&道具&排行榜</title>
<style>
  html,body{height:100%;margin:0;background:#0c0f12;color:#eef;font-family:system-ui,-apple-system,Segoe UI,Roboto}
  .wrap{display:flex;align-items:center;justify-content:center;height:100%}
  canvas{background:#000;border:1px solid #222;box-shadow:0 10px 30px rgba(0,0,0,.65);touch-action:none}

  .tag{position:fixed;left:12px;top:12px;font-size:12px;opacity:.9;background:rgba(255,255,255,.05);border:1px solid #2a2f3a;padding:6px 8px;border-radius:10px}
  .hud{position:fixed;left:50%;top:10px;transform:translateX(-50%);display:flex;gap:14px;align-items:center;font-weight:800;letter-spacing:.3px}
  .btnbar{position:fixed;right:12px;top:10px;display:flex;gap:8px}
  .iconbtn{width:36px;height:36px;border-radius:10px;border:1px solid #2a2f3a;background:rgba(255,255,255,.06);display:grid;place-items:center;cursor:pointer;user-select:none}

  .meter{position:fixed;right:12px;top:56px;width:154px;height:10px;border:1px solid #2a2f3a;border-radius:8px;background:rgba(255,255,255,.06);overflow:hidden}
  .meter>i{display:block;height:100%;background:#6ce1ff;transform-origin:left center;transition:width .1s}
  .shieldbar{position:fixed;right:12px;top:74px;width:154px;height:10px;border:1px solid #2a2f3a;border-radius:8px;background:rgba(255,255,255,.06);overflow:hidden}
  .shieldbar>i{display:block;height:100%;background:#7dffa5;transform-origin:left center;transition:width .1s}
  .coins{position:fixed;right:12px;top:94px;font-weight:700;opacity:.95;background:rgba(255,255,255,.06);border:1px solid #2a2f3a;border-radius:10px;padding:4px 8px}

  .combo{position:fixed;left:50%;top:56px;transform:translateX(-50%);font-weight:900;font-size:20px;pointer-events:none;text-shadow:0 2px 8px rgba(0,0,0,.5);opacity:.95}
  .levelBanner{position:fixed;left:50%;top:40%;transform:translate(-50%,-50%) scale(.6);font-size:26px;font-weight:900;letter-spacing:.5px;background:rgba(0,0,0,.35);padding:10px 14px;border:1px solid #2a2f3a;border-radius:12px;opacity:0;transition:.28s}
  .tip{position:fixed;left:12px;bottom:12px;font-size:12px;opacity:.85}

  .overlay{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.55);visibility:hidden;opacity:0;transition:.2s}
  .show{visibility:visible;opacity:1}
  .card{background:#151a22;border:1px solid #2a2f3a;padding:16px 18px;border-radius:14px;text-align:center;max-width:92vw;color:#dfe7ff}
  .btn{display:inline-block;margin-top:10px;padding:10px 16px;border-radius:10px;border:1px solid #2a2f3a;background:#18202b;cursor:pointer;user-select:none}
  .small{opacity:.8;font-size:13px;margin-top:6px}
  .lb{position:fixed;right:12px;bottom:12px;font-size:12px;opacity:.95;background:rgba(255,255,255,.06);border:1px solid #2a2f3a;border-radius:10px;padding:6px 10px}
  input[type=text]{width:220px;padding:8px 10px;border-radius:10px;border:1px solid #2a2f3a;background:#10151d;color:#dfe7ff}
</style>
</head>
<body>
  <div class="tag">🦖 Dino & Fruits · 像素 v6.0</div>

  <div class="hud">
    分数：<span id="score">0</span>
    <span>· 最高分：<span id="best">0</span></span>
    <span id="lives"></span>
  </div>

  <div class="btnbar">
    <div class="iconbtn" id="pauseBtn" title="暂停/继续">⏸️</div>
    <div class="iconbtn" id="muteBtn" title="静音/开音">🔊</div>
  </div>

  <div class="meter" title="冲刺冷却（Shift）"><i id="dashFill" style="width:100%"></i></div>
  <div class="shieldbar" title="护盾剩余（拾取盾牌）"><i id="shieldFill" style="width:0%"></i></div>
  <div class="coins" title="金币（+5分）">🪙 x <span id="coinCnt">0</span></div>

  <div id="comboEl" class="combo"></div>
  <div id="banner" class="levelBanner"></div>
  <div id="tip" class="tip"></div>
  <div id="lbBtn" class="lb" title="查看排行榜">🏆 排行榜</div>

  <div class="wrap"><canvas id="game" width="520" height="820"></canvas></div>

  <div id="overlay" class="overlay">
    <div class="card" id="menuCard">
      <h2 style="margin:6px 0 6px">小恐龙躲水果 · 像素进阶</h2>
      <div id="msg">
        每 30 秒升一关并切换规则：Gold Rush / Bomb Storm / Ice Age / Heavy Rain / Reverse Controls / Speed Up。<br>
        🪙 金币 +5 · ❄️ 雪花 冻结 · 🛡 盾牌 护体 · 💣 炸弹 危险。冲刺可打出连击！
      </div>
      <div class="small">R 重开 · 空格暂停/继续 · 手机左右拖拽 · 点开始播放BGM</div>
      <div class="btn" id="start">开始游戏</div>
    </div>

    <div class="card" id="lbCard" style="display:none;text-align:left;max-width:560px">
      <h3 style="margin:6px 0 10px">🏆 本地排行榜（Top 5）</h3>
      <ol id="lbList" style="margin:0 0 10px 20px;padding:0"></ol>
      <div id="lbHint" style="opacity:.85;margin-bottom:8px"></div>
      <div id="recap" style="opacity:.95;margin:8px 0"></div>
      <div id="lbInputWrap" style="display:none;margin-top:6px">
        <div style="margin:6px 0">你的名字：</div>
        <input type="text" id="lbName" maxlength="16" placeholder="输入昵称"/>
        <button class="btn" id="lbSave">保存成绩</button>
      </div>
      <div style="margin-top:8px">
        <button class="btn" id="lbClose">关闭</button>
      </div>
    </div>
  </div>

<script>
/* ===== Pixel Canvas Setup (offscreen low-res -> upscale, no smoothing) ===== */
const canvas = document.getElementById('game');
const mc = canvas.getContext('2d'); // main (only for blit)
const W = canvas.width, H = canvas.height;
const pcanvas = document.createElement('canvas');
pcanvas.width = W/2; pcanvas.height = H/2; // half-res for chunky pixels
const c = pcanvas.getContext('2d'); c.imageSmoothingEnabled = false;
mc.imageSmoothingEnabled = false;

/* ===== UI refs ===== */
const scoreEl = document.getElementById('score');
const bestEl  = document.getElementById('best');
const livesEl = document.getElementById('lives');
const overlay = document.getElementById('overlay');
const startBtn = document.getElementById('start');
const msgEl = document.getElementById('msg');
const pauseBtn = document.getElementById('pauseBtn');
const muteBtn = document.getElementById('muteBtn');
const dashFill = document.getElementById('dashFill');
const shieldFill = document.getElementById('shieldFill');
const comboEl = document.getElementById('comboEl');
const tipEl = document.getElementById('tip');
const bannerEl = document.getElementById('banner');
const lbBtn = document.getElementById('lbBtn');
const menuCard = document.getElementById('menuCard');
const lbCard = document.getElementById('lbCard');
const lbList = document.getElementById('lbList');
const lbHint = document.getElementById('lbHint');
const recapEl = document.getElementById('recap');
const lbInputWrap = document.getElementById('lbInputWrap');
const lbName = document.getElementById('lbName');
const lbSave = document.getElementById('lbSave');
const lbClose = document.getElementById('lbClose');
const coinCntEl = document.getElementById('coinCnt');

/* ===== State ===== */
let keys = new Set(), pointerX = null;
let state='menu'; // menu | play | pause | dead
let score=0, time=0, spawnTimer=0, powerTimer=0, coinTimer=0, bombTimer=0, iceTimer=0;
let best = Number(localStorage.getItem('dino_highscore_v6')||0); bestEl.textContent = best;
let lives = 3, invincible = 0, blink = 0;
let dashing = 0, dashCooldown = 0; const DASH_DURATION = 0.35, DASH_COOLDOWN = 3.0;
let shield = 0; const SHIELD_GAIN = 5.0;
let combo = 0, comboTimer = 0; const COMBO_WINDOW = 1.2;
let rainy = Math.random() < 0.25, freezeAll = 0;
let level = 1, levelClock = 0, levelRule = 'Normal', bannerT=0;
const LEVEL_LEN = 30; // s
const RULES = ['Gold Rush','Bomb Storm','Ice Age','Heavy Rain','Reverse Controls','Speed Up'];

/* 统计（复盘） */
let maxCombo = 0, coinsGot = 0, diedAtLevel = 1;
let firstSeen = { coin:false, ice:false, shield:false, bomb:false };

/* Entities */
let fruits=[], powers=[], coins=[], bombs=[], particles=[], floatTexts=[];
const rnd=(a,b)=>Math.random()*(b-a)+a;

/* ===== Audio (synth) ===== */
let audioCtx = null, masterGain = null, bgmTimer = null, muted=false;
function initAudio(){ if (audioCtx) return; audioCtx = new (window.AudioContext||window.webkitAudioContext)(); masterGain = audioCtx.createGain(); masterGain.gain.value = 0.28; masterGain.connect(audioCtx.destination); }
function tone(freq, dur=0.12, type='sine', vol=0.5){ if (!audioCtx || muted) return; const o=audioCtx.createOscillator(), g=audioCtx.createGain(); o.type=type; o.frequency.value=freq; g.gain.value=0; o.connect(g); g.connect(masterGain); const t=audioCtx.currentTime; g.gain.linearRampToValueAtTime(0,t); g.gain.linearRampToValueAtTime(vol,t+0.005); g.gain.exponentialRampToValueAtTime(0.0001,t+dur); o.start(t); o.stop(t+dur+0.02); }
function sfxScore(){ tone(900,0.08,'square',0.18); }
function sfxHit(){ tone(160,0.25,'sawtooth',0.22); tone(100,0.25,'square',0.15); }
function sfxBest(){ tone(1244.5,0.18,'square',0.22); tone(1661.2,0.18,'square',0.12); }
function sfxShield(){ tone(660,0.16,'triangle',0.22); tone(990,0.12,'sine',0.18); }
function sfxDash(){ tone(520,0.12,'sawtooth',0.22); tone(740,0.10,'square',0.12); }
function sfxCombo(k){ tone(900+60*k,0.09,'square',0.22); }
function sfxCoin(){ tone(880,0.08,'triangle',0.22); tone(1320,0.12,'sine',0.22); }
function sfxIce(){ tone(520,0.16,'triangle',0.2); tone(380,0.22,'sine',0.12); }
function sfxBomb(){ tone(160,0.18,'square',0.24); tone(90,0.24,'sawtooth',0.22); }
function startBGM(){ if (!audioCtx || muted) return; stopBGM(); const bpm=116, beat=60/bpm; const scale=[261.63,293.66,329.63,349.23,392,440,493.88,523.25]; let i=0; bgmTimer=setInterval(()=>{ const root=scale[[0,2,4,5][Math.floor(i/4)%4]]; play(root/2, beat*0.9,'triangle',0.12); let bonus=combo>0?Math.min(6,Math.floor(combo/3)):0; const melody=[0,2,4,5,4,2,0,2, 4,5,7,5,4,2,0, -1,0,2,4,5,4,2,0, 2,4,5,7,9,7,5,4]; const note=scale[(melody[i%melody.length]+8+bonus)%8]||root; play(note,beat*0.45,'sine',0.16); i++; }, (beat/2)*1000); function play(f,d,t,v){ if(!muted) tone(f,d,t,v);} }
function stopBGM(){ if (bgmTimer){ clearInterval(bgmTimer); bgmTimer=null; } }

/* ===== HUD ===== */
function renderLives(){ let hearts=''; for(let i=0;i<lives;i++) hearts+='❤️'; livesEl.textContent = `· 生命：${hearts||'—'}`; }
function addScore(n,bounce=false){ score+=n; scoreEl.textContent=score; scoreEl.style.transform='scale(1.08)'; setTimeout(()=>scoreEl.style.transform='scale(1)',90); sfxScore(); if(score>best){ best=score; bestEl.textContent=best; localStorage.setItem('dino_highscore_v6', best); sfxBest(); } }

/* ===== Pixel helpers ===== */
function pClear(){ c.setTransform(1,0,0,1,0,0); c.clearRect(0,0,pcanvas.width, pcanvas.height); c.setTransform(1,0,0,1,0,0); }
function pPresent(){ mc.clearRect(0,0,W,H); mc.imageSmoothingEnabled=false; mc.drawImage(pcanvas,0,0,W,H); }
function pixRect(x,y,w,h,col,alpha=1){ c.globalAlpha=alpha; c.fillStyle=col; c.fillRect((x/2)|0,(y/2)|0, Math.max(1,(w/2)|0), Math.max(1,(h/2)|0)); c.globalAlpha=1; }
function pixCircle(x,y,r,col,alpha=1){ c.globalAlpha=alpha; c.fillStyle=col; c.beginPath(); c.arc((x/2),(y/2),(r/2),0,Math.PI*2); c.fill(); c.globalAlpha=1; }
function pixText(x,y,txt,size=16,col='#fff'){ c.fillStyle=col; c.font=`bold ${size/2}px system-ui`; c.fillText(txt,(x/2)|0,(y/2)|0); }

/* ===== Dino ===== */
const dino = { x: W/2, y: H-110, w: 54, h: 32, speed: 4.6, vx:0 };
function drawDino(){
  // shadow
  pixCircle(dino.x, dino.y+18, 16, 'rgba(0,0,0,.28)');
  const flashing = invincible>0 || dashing>0;
  const alpha = (flashing && Math.floor(perfNow*20)%2===0)?0.55:1;
  // shield ring
  if (shield>0) pixCircle(dino.x, dino.y-2, 44 + 2*Math.sin(perfNow*4), 'rgba(125,255,165,.35)');
  // body (blocky)
  pixRect(dino.x-32, dino.y-18, 68, 32, `rgba(62,207,107,${alpha})`);
  pixRect(dino.x-10, dino.y-6, 40, 18, `rgba(232,255,241,${alpha})`);
  pixRect(dino.x+24, dino.y-26, 24, 20, `rgba(62,207,107,${alpha})`);
  pixRect(dino.x+48, dino.y-18, 14, 8, `rgba(62,207,107,${alpha})`); // mouth
  pixRect(dino.x-6, dino.y-4, 8, 3, `rgba(62,207,107,${alpha})`);    // hand
  pixRect(dino.x-32, dino.y-8, 20, 10, `rgba(62,207,107,${alpha})`); // tail
  pixRect(dino.x-12, dino.y+12, 12, 6, `rgba(199,247,218,${alpha})`); // feet
  pixRect(dino.x+6, dino.y+12, 12, 6, `rgba(199,247,218,${alpha})`);
  // eye
  if (blink>0 && blink<0.12) pixRect(dino.x+40, dino.y-17, 6, 2, '#0b0c10');
  else pixRect(dino.x+41, dino.y-20, 4, 4, '#0b0c10');

  // dash ghost
  if (dashing>0) pixRect(dino.x-32-10*Math.sign(dino.vx||1), dino.y-18, 68, 32, 'rgba(169,255,209,.14)');
}

/* ===== Fruits (keep simple pixel shapes) ===== */
const FRUIT_TYPES = [
  {name:'apple', w:[26,34], h:20, col:'#ff6b6b', draw:(b)=>{ fruitShadow(b); pixRect(b.x, b.y, b.w, b.h, b.col); pixRect(b.x+b.w*0.7, b.y-2, 6, 4, '#6ad66a'); }},
  {name:'banana', w:[30,44], h:12, col:'#ffd166', draw:(b)=>{ fruitShadow(b); pixRect(b.x, b.y+4, b.w, 4, b.col); pixRect(b.x+4, b.y+2, b.w-8, 4, b.col); }},
  {name:'orange', w:[24,30], h:24, col:'#ffa62b', draw:(b)=>{ fruitShadow(b); pixCircle(b.x+b.w/2, b.y+b.h/2, b.w, b.col); pixRect(b.x+b.w/2-1, b.y-3, 2, 6, '#5ec27f'); }},
  {name:'grape', w:[26,32], h:26, col:'#9b5de5', draw:(b)=>{ fruitShadow(b); for(let i=0;i<6;i++){ const row=i>>1, col=i%3-1; pixCircle(b.x+b.w/2+col*6, b.y+b.h/2+(row-0.5)*6, 6, b.col); } pixRect(b.x+b.w/2-1, b.y-4, 2, 6, '#6ad66a'); }},
  {name:'watermelon', w:[32,46], h:20, col:'#ff5c8a', draw:(b)=>{ fruitShadow(b); pixRect(b.x, b.y+b.h-6, b.w, 6, '#2dd38a'); pixRect(b.x, b.y+b.h-14, b.w, 8, b.col); }},
];
function fruitShadow(b){ pixCircle(b.x+b.w/2, b.y+b.h+6, Math.max(6,b.w*.45), 'rgba(0,0,0,.28)'); }

/* ===== Items: coin / snowflake ice / shield / bomb ===== */
function drawCoin(t){ // 🪙 or ¥
  fruitShadow({x:t.x,y:t.y,w:t.w,h:t.h});
  pixCircle(t.x+t.w/2, t.y+t.h/2, t.w, '#f4d35e');
  pixCircle(t.x+t.w/2, t.y+t.h/2, t.w-6, '#ffe28a');
  pixText(t.x+t.w/2-6, t.y+t.h/2+4, (Math.random()<.5?'¥':'$'), 16, '#5c3b00');
}
function drawSnow(p){ // ❄️ 雪花
  const cx=p.x+p.w/2, cy=p.y+p.h/2;
  pixCircle(cx, cy, p.w+6, 'rgba(160,210,255,.12)');
  pixRect(cx-1, cy-8, 2, 16, '#aee7ff');
  pixRect(cx-8, cy-1, 16, 2, '#aee7ff');
  pixRect(cx-6, cy-6, 12, 2, '#aee7ff'); pixRect(cx-6, cy+4, 12, 2, '#aee7ff');
}
function drawShieldItem(b){ // 🛡
  const cx=b.x+b.w/2, cy=b.y+b.h/2;
  pixRect(cx-10, cy-8, 20, 16, 'rgba(67,245,143,1)');
  pixRect(cx-8, cy-6, 16, 12, 'rgba(10,30,16,0.22)');
}
function drawBomb(b){ // 💣
  fruitShadow({x:b.x,y:b.y,w:b.w,h:b.h});
  pixCircle(b.x+b.w/2, b.y+b.h/2, b.w, '#222');
  pixRect(b.x+b.w/2-1, b.y-10, 2, 10, '#555'); // fuse
  pixCircle(b.x+b.w/2+8, b.y-12, 6, 'rgba(255,207,90,.9)');
}

/* ===== Spawners ===== */
function spawnFruit(){ const t=FRUIT_TYPES[Math.floor(rnd(0,FRUIT_TYPES.length))]; const w=rnd(t.w[0],t.w[1]), h=t.h; const x=rnd(6,W-w-6), y=-30; let vy=rnd(2.3,3.8)+Math.min(time/28,3.4); if (rainy || levelRule==='Heavy Rain') vy+=0.8; if (freezeAll>0) vy*=0.2; fruits.push({type:t,x,y,w,h,vy,ang:0,col:t.col}); }
function spawnShield(){ const w=26,h=26,x=rnd(10,W-10-w),y=-30; let vy=(freezeAll>0?0.8:1)*(rnd(2.0,3.2)+Math.min(time/35,2.2)); powers.push({kind:'shield',x,y,w,h,vy}); }
function spawnSnow(){ const w=28,h=28,x=rnd(10,W-10-w),y=-30; let vy=(freezeAll>0?0.8:1)*(rnd(2.0,3.0)+Math.min(time/40,2.0)); powers.push({kind:'ice',x,y,w,h,vy}); }
function spawnCoin(){ const w=26,h=26,x=rnd(10,W-10-w),y=-30; let vy=rnd(2.6,3.8)+Math.min(time/30,2.6); if (freezeAll>0) vy*=0.2; coins.push({x,y,w,h,vy}); }
function spawnBomb(){ const w=26,h=26,x=rnd(10,W-10-w),y=-30; let vy=rnd(2.6,4.2)+Math.min(time/28,3.0); if (freezeAll>0) vy*=0.2; bombs.push({x,y,w,h,vy}); }

/* ===== Background (pixel parallax + rule tint) ===== */
function drawParallax(){
  const t=(Math.sin(perfNow/12)+1)/2;
  const top = lerpColor([22,28,58],[4,8,20], t);
  const bot = lerpColor([120,170,255],[30,40,70], t);
  const grd=c.createLinearGradient(0,0,0,pcanvas.height); grd.addColorStop(0,`rgb(${top[0]},${top[1]},${top[2]})`); grd.addColorStop(1,`rgb(${bot[0]},${bot[1]},${bot[2]})`);
  c.fillStyle=grd; c.fillRect(0,0,pcanvas.width, pcanvas.height);

  // hills
  c.fillStyle='rgba(40,60,100,.95)'; drawHills(0.25, 70);
  c.fillStyle='rgba(60,80,120,.9)'; drawHills(0.15, 40);

  // clouds
  c.fillStyle='rgba(255,255,255,.28)';
  for(let i=0;i<5;i++){ const x=((i*180 + (perfNow*20))%(W+220))-110; const y=80+(i%3)*30; drawCloud(x,y, 70+i*6); }

  // ground
  pixRect(0,H-80,W,80,'#1b2e1e'); pixRect(0,H-64,W,64,'#284a2e');
  for(let x=0;x<W;x+=14) pixRect(x, H-64, 2, 8+3*Math.sin((x+perfNow*40)/20), 'rgba(0,0,0,.22)');

  // rule tint
  let tint=null;
  if (levelRule==='Ice Age') tint='rgba(120,180,255,.10)';
  else if (levelRule==='Heavy Rain') tint='rgba(150,170,190,.10)';
  else if (levelRule==='Gold Rush') tint='rgba(255,210,120,.08)';
  if (tint) pixRect(0,0,W,H,tint);
}

/* helpers for bg */
function drawHills(speed, baseY){
  c.beginPath();
  for(let x=0;x<=pcanvas.width;x+=5){
    const sx=x*2, y = H - 120 - baseY - 18*Math.sin((sx*0.01)+(perfNow*speed));
    const px=(sx/2)|0, py=(y/2)|0;
    x===0?c.moveTo(px,py):c.lineTo(px,py);
  }
  c.lineTo(pcanvas.width, pcanvas.height); c.lineTo(0, pcanvas.height); c.closePath(); c.fill();
}
function drawCloud(x,y,w){ pixCircle(x, y, w*0.8, 'rgba(255,255,255,.25)'); pixCircle(x+w*0.35,y+6, w*0.56,'rgba(255,255,255,.25)'); pixCircle(x-w*0.35,y+10,w*0.56,'rgba(255,255,255,.25)'); }
function lerpColor(a,b,t){ return [ Math.round(a[0]+(b[0]-a[0])*t), Math.round(a[1]+(b[1]-a[1])*t), Math.round(a[2]+(b[2]-a[2])*t) ]; }

/* ===== Particles / float text ===== */
function splash(x,y,col='#9ad', n=14){ for(let i=0;i<n;i++){ particles.push({x,y, vx:rnd(-2,2), vy:rnd(-3,0), r:rnd(1,2.6), col, life:1}); } }
function floatText(x,y,txt,col='#fff'){ floatTexts.push({x,y,txt,col,life:1}); }

function drawParticles(){
  for (let i=particles.length-1;i>=0;i--){ const p=particles[i]; p.x+=p.vx; p.y+=p.vy; p.vy+=0.1; p.life-=0.016; if (p.life<=0) particles.splice(i,1); }
  particles.forEach(p=>{ pixCircle(p.x,p.y,p.r, p.col, Math.max(0,p.life)); });
}
function drawFloatTexts(){
  floatTexts.forEach(ft=>{ ft.y-=0.6; ft.life-=0.02; c.globalAlpha=Math.max(0,ft.life); pixText(ft.x, ft.y, ft.txt, 18, ft.col); c.globalAlpha=1; });
  floatTexts = floatTexts.filter(ft=>ft.life>0);
}

/* ===== Level banner (slide + scale + pixels) ===== */
function showBanner(text){
  bannerEl.textContent = text;
  bannerEl.style.opacity = 1; bannerEl.style.transform='translate(-50%,-50%) scale(.6)';
  // pixel sparks
  for (let i=0;i<28;i++){ splash(W/2 + rnd(-40,40), H*0.4 + rnd(-12,12), '#ffd166', 1); }
  setTimeout(()=>{ bannerEl.style.transform='translate(-50%,-50%) scale(1)'; }, 10);
  setTimeout(()=>{ bannerEl.style.opacity = 0; }, 1600);
}

/* ===== Input ===== */
document.addEventListener('keydown', e=>{
  if (e.key==='r'||e.key==='R'){ startGame(); return; }
  if (e.key===' '){ togglePause(); return; }
  keys.add(e.key);
});
document.addEventListener('keyup', e=>keys.delete(e.key));
const touch = (x)=>{ const rect=canvas.getBoundingClientRect(); pointerX = x - rect.left; };
canvas.addEventListener('pointerdown', e=>touch(e.clientX));
canvas.addEventListener('pointermove', e=>{ if (e.buttons) touch(e.clientX); });
window.addEventListener('pointerup', ()=>{ pointerX=null; });

startBtn.addEventListener('click', ()=>{ initAudio(); audioCtx.resume(); startGame(); });
const lbKey='dino_lb_top5';
lbBtn.addEventListener('click', ()=> showLeaderboard(false));
lbClose.addEventListener('click', ()=>{ menuCard.style.display=''; lbCard.style.display='none'; if (state!=='menu') overlay.classList.remove('show'); });
lbSave.addEventListener('click', ()=>{ const name=(lbName.value||'Player').trim().slice(0,16); saveToLeaderboard(name, score); showLeaderboard(false); lbInputWrap.style.display='none'; });

/* ===== Leaderboard ===== */
function loadLeaderboard(){ try{ const a=JSON.parse(localStorage.getItem(lbKey)||'[]'); return Array.isArray(a)?a:[]; }catch(e){ return []; } }
function saveLeaderboard(arr){ localStorage.setItem(lbKey, JSON.stringify(arr.slice(0,5))); }
function formatDate(){ const d=new Date(); const mm=String(d.getMonth()+1).padStart(2,'0'); const dd=String(d.getDate()).padStart(2,'0'); return `${mm}-${dd}`; }
function showLeaderboard(fromOver){
  const lb=loadLeaderboard();
  lbList.innerHTML = lb.map(e=>`<li><b>${e.name||'Player'}</b> — ${e.score} 分 <span style="opacity:.7">(${e.date||''})</span></li>`).join('') || '<li>暂无记录</li>';
  lbHint.textContent = fromOver ? `你的分数：${score} 分` : '显示本地前五名成绩';
  recapEl.innerHTML = fromOver ? `你在 <b>Level ${diedAtLevel} · ${levelRule}</b> 挂了｜最大连击：<b>${maxCombo}</b>｜金币：<b>${coinsGot}</b>` : '';
  const qualifies = fromOver && (lb.length<5 || score>lb[lb.length-1].score);
  lbInputWrap.style.display = qualifies ? '' : 'none';
  if (qualifies){ lbName.value=''; setTimeout(()=>lbName.focus(), 50); }
  menuCard.style.display='none'; lbCard.style.display=''; overlay.classList.add('show');
}
function saveToLeaderboard(name, sc){ const lb=loadLeaderboard(); lb.push({name, score:sc, date:formatDate()}); lb.sort((a,b)=>b.score-a.score); saveLeaderboard(lb); lbList.innerHTML = lb.map(e=>`<li><b>${e.name||'Player'}</b> — ${e.score} 分 <span style="opacity:.7">(${e.date||''})</span></li>`).join(''); }

/* ===== Game flow ===== */
function reset(){
  dino.x=W/2; dino.vx=0;
  fruits.length=0; powers.length=0; coins.length=0; bombs.length=0; particles.length=0; floatTexts.length=0;
  spawnTimer=0; powerTimer=rnd(2.0,3.4); coinTimer=rnd(3.0,5.0); bombTimer=rnd(2.4,4.0); iceTimer=rnd(4.0,6.0);
  score=0; time=0; lives=3; invincible=0; blink=0;
  dashing=0; dashCooldown=0; shield=0; combo=0; comboTimer=0;
  scoreEl.textContent='0'; renderLives(); dashFill.style.width='100%'; shieldFill.style.width='0%';
  rainy = Math.random() < 0.25; freezeAll=0;
  level=1; levelClock=0; levelRule='Normal'; showBanner('LEVEL 1 · Normal'); tipEl.textContent = rainy?'🌧 天气：小雨':'☀️ 天气：晴';
  // recap stats
  maxCombo=0; coinsGot=0; diedAtLevel=1; firstSeen={coin:false,ice:false,shield:false,bomb:false};
  comboEl.textContent='';
}
function startGame(){ reset(); state='play'; menuCard.style.display=''; lbCard.style.display='none'; overlay.classList.remove('show'); if (!audioCtx) initAudio(); if (audioCtx.state==='suspended') audioCtx.resume(); if (!muted) startBGM(); }
function togglePause(){ if (state==='play'){ state='pause'; stopBGM(); overlay.classList.add('show'); msgEl.textContent='已暂停（空格继续）'; } else if (state==='pause'){ state='play'; overlay.classList.remove('show'); if(!muted) startBGM(); } }

function setRule(rule){ levelRule = rule; if (rule==='Reverse Controls') tip('方向键已反向（触控不变）'); if (rule==='Gold Rush') tip('金币暴雨！🪙'); if (rule==='Ice Age') tip('❄️ 冰冻道具高发'); if (rule==='Bomb Storm') tip('💣 炸弹高发'); if (rule==='Heavy Rain') tip('🌧 大雨来袭'); if (rule==='Speed Up') tip('⏩ 更快更密'); showBanner(`LEVEL ${level} · ${rule}`); }
function tip(t){ tipEl.textContent = t; setTimeout(()=>{ if (tipEl.textContent===t) tipEl.textContent=''; }, 2600); }

/* ===== Update & Draw ===== */
let perfNow=0;
function update(dt){
  time+=dt; levelClock+=dt;
  if (invincible>0) invincible=Math.max(0,invincible-dt);
  if (dashing>0) dashing=Math.max(0,dashing-dt);
  if (dashCooldown>0) dashCooldown=Math.max(0,dashCooldown-dt);
  if (shield>0) shield=Math.max(0,shield-dt);
  if (freezeAll>0) freezeAll=Math.max(0,freezeAll-dt);
  blink-=dt; if (blink<=-rnd(2.5,4)) blink=0.18;
  if (combo>0){ comboTimer-=dt; if (comboTimer<=0){ combo=0; comboEl.textContent=''; } }

  // Level switch
  if (levelClock>=LEVEL_LEN){ level++; levelClock=0; const rule=RULES[(level-2)%RULES.length]; setRule(rule); }

  // Input
  let move=0;
  if (keys.has('ArrowLeft')||keys.has('a')) move -= 1;
  if (keys.has('ArrowRight')||keys.has('d')) move += 1;
  if (levelRule==='Reverse Controls') move = -move;
  if (pointerX!=null){ const dir=Math.sign(pointerX - dino.x); move = Math.abs(pointerX-dino.x)<4 ? 0 : dir; }
  if ((keys.has('Shift')||keys.has('ShiftLeft')||keys.has('ShiftRight')) && dashing<=0 && dashCooldown<=0){ dashing=DASH_DURATION; dashCooldown=DASH_COOLDOWN; sfxDash(); }
  const spdMul=dashing>0?2.05:1.0;
  dino.vx = move * dino.speed * spdMul; dino.x += dino.vx; dino.x = Math.max(40, Math.min(W-40, dino.x));

  // Spawn pacing
  spawnTimer -= dt;
  let interval = Math.max(0.18, 0.9 - time*0.02 - Math.max(0,level-1)*0.02);
  if (levelRule==='Speed Up') interval *= 0.8;
  if (spawnTimer<=0){ spawnFruit(); spawnTimer=interval; }

  powerTimer -= dt; coinTimer -= dt; bombTimer -= dt; iceTimer -= dt;
  if (powerTimer<=0){ if (Math.random()<0.45) spawnShield(); powerTimer=rnd(2.0,3.4); }
  if (iceTimer<=0 || levelRule==='Ice Age'){ if (Math.random()< (levelRule==='Ice Age'?0.85:0.5)) spawnSnow(); iceTimer=rnd(3.0,5.0); }
  if (coinTimer<=0 || levelRule==='Gold Rush'){ if (Math.random()< (levelRule==='Gold Rush'?0.92:0.6)) spawnCoin(); coinTimer=rnd(2.6,4.4); }
  if (bombTimer<=0 || levelRule==='Bomb Storm'){ if (Math.random()< (levelRule==='Bomb Storm'?0.9:0.55)) spawnBomb(); bombTimer=rnd(2.2,3.8); }

  const slow = freezeAll>0 ? 0.2 : 1;
  fruits.forEach(b=>{ b.y += b.vy*slow; });
  powers.forEach(p=>{ p.y += p.vy*slow; });
  coins.forEach(g=>{ g.y += g.vy*slow; });
  bombs.forEach(b=>{ b.y += b.vy*slow; });

  // Remove offscreen + score for escaped fruits
  const before=fruits.length; fruits = fruits.filter(b=> b.y <= H+40 ); const removed=before-fruits.length; if (removed>0) addScore(removed);
  powers = powers.filter(p=> p.y <= H+40); coins = coins.filter(g=> g.y <= H+40); bombs = bombs.filter(b=> b.y <= H+40);

  // Pickups
  for (let i=powers.length-1;i>=0;i--){ const p=powers[i]; if (hitBox(dino.x,dino.y,dino.w,dino.h, p.x+p.w/2,p.y+p.h/2,p.w,p.h,0.9)){ if (p.kind==='shield'){ shield+=SHIELD_GAIN; sfxShield(); splash(p.x+p.w/2,p.y+p.h/2,'#7dffa5'); if(!firstSeen.shield){ tip('🛡 盾牌：5秒免疫'); firstSeen.shield=true; } } if (p.kind==='ice'){ freezeAll=4.0; sfxIce(); splash(p.x+p.w/2,p.y+p.h/2,'#aee7ff'); if(!firstSeen.ice){ tip('❄️ 雪花：全场冻结4s'); firstSeen.ice=true; } } powers.splice(i,1); } }
  for (let i=coins.length-1;i>=0;i--){ const g=coins[i]; if (hitBox(dino.x,dino.y,dino.w,dino.h, g.x+g.w/2,g.y+g.h/2,g.w,g.h,0.9)){ addScore(5,true); coinsGot++; coinCntEl.textContent=String(coinsGot); sfxCoin(); splash(g.x+g.w/2,g.y+g.h/2,'#ffd166'); if(!firstSeen.coin){ tip('🪙 金币：+5 分'); firstSeen.coin=true; } coins.splice(i,1); } }

  // Dash interactions
  if (dashing>0){
    for (let i=fruits.length-1;i>=0;i--){ const b=fruits[i]; const bx=b.x+b.w/2, by=b.y+b.h/2; if (hitBox(dino.x,dino.y,dino.w,dino.h, bx,by,b.w,b.h,0.92)){ fruits.splice(i,1); combo+=1; comboTimer=COMBO_WINDOW; comboEl.textContent=`COMBO ×${combo}`; maxCombo=Math.max(maxCombo,combo); sfxCombo(combo); floatText(bx,by,`+${1*combo}`,'#aaf'); addScore(1*combo); splash(bx,by,'#9ad'); } }
    for (let i=bombs.length-1;i>=0;i--){ const b=bombs[i]; const bx=b.x+b.w/2,by=b.y+b.h/2; if (hitBox(dino.x,dino.y,dino.w,dino.h, bx,by,b.w,b.h,0.95)){ bombs.splice(i,1); sfxBomb(); splash(bx,by,'#ff9b6b',22); if(!firstSeen.bomb){ tip('💣 冲刺/护盾可安全引爆'); firstSeen.bomb=true; } } }
  }

  // Bomb hit (no dash, no invincible)
  if (invincible<=0 && dashing<=0){
    for (let i=bombs.length-1;i>=0;i--){ const b=bombs[i]; const bx=b.x+b.w/2,by=b.y+b.h/2; if (hitBox(dino.x,dino.y,dino.w,dino.h, bx,by,b.w,b.h,0.85)){ bombs.splice(i,1); onHit(); sfxBomb(); splash(bx,by,'#ff6b6b',26); fruits = fruits.filter(f=> Math.hypot((f.x+f.w/2)-bx,(f.y+f.h/2)-by) > 80); break; } }
  }

  // Normal fruit hit (no shield/dash/inv)
  if (invincible<=0 && shield<=0 && dashing<=0){
    for (let b of fruits){ const bx=b.x+b.w/2, by=b.y+b.h/2; if (hitBox(dino.x,dino.y,dino.w,dino.h, bx,by,b.w,b.h,0.78)){ onHit(); break; } }
  }

  // HUD bars
  dashFill.style.width = `${(1 - dashCooldown/DASH_COOLDOWN)*100}%`;
  shieldFill.style.width = `${Math.min(1, shield/SHIELD_GAIN)*100}%`;
}
function draw(){
  pClear(); drawParallax();
  if (rainy || levelRule==='Heavy Rain') drawRain();
  drawParticles(); drawDino();

  // fruits & items
  fruits.forEach(b=> b.type.draw(b));
  powers.forEach(p=> p.kind==='shield'?drawShieldItem(p):drawSnow(p));
  coins.forEach(g=> drawCoin(g));
  bombs.forEach(b=> drawBomb(b));

  // difficulty bar
  pixRect(10, H-14, Math.min(1, time/30)*(W-20), 4, 'rgba(255,255,255,.3)');
  drawFloatTexts();

  // freeze overlay
  if (freezeAll>0) pixRect(0,0,W,H,'rgba(120,180,255,0.10)');
}

/* Rain (pixel) */
let raindrops=[]; for(let i=0;i<100;i++) raindrops.push({x:Math.random()*W,y:Math.random()*H,v:6+Math.random()*8});
function drawRain(){ for(let r of raindrops){ pixRect(r.x, r.y, 2, 10, 'rgba(200,220,255,.25)'); r.x-=1.2; r.y+=r.v; if (r.y>H){ r.y=-10; r.x=Math.random()*W; } } }

/* Collisions */
function hitBox(px,py,pw,ph, bx,by,bw,bh,k=1){ return Math.abs(px - bx) < (pw/2 + bw/2)*k && Math.abs(py - by) < (ph/2 + bh/2)*k; }

/* Damage & Game Over */
function onHit(){
  if (shield>0){ shield=0; sfxHit(); splash(dino.x, dino.y-8, '#7dffa5', 22); return; }
  lives -= 1; renderLives(); sfxHit(); invincible=1.2; combo=0; comboEl.textContent=''; splash(dino.x, dino.y-8, '#ff6b6b', 22);
  fruits = fruits.filter(b=> b.y < dino.y - 50);
  if (lives<=0){ diedAtLevel = level; gameOver(); }
}
function gameOver(){
  state='dead'; stopBGM();
  if (score>=best){ best=score; bestEl.textContent=best; localStorage.setItem('dino_highscore_v6', best); }
  showLeaderboard(true);
}

/* Leaderboard view */
function showLeaderboard(fromGameOver){
  const lb=loadLeaderboard();
  lbList.innerHTML = lb.map(e=>`<li><b>${e.name||'Player'}</b> — ${e.score} 分 <span style="opacity:.7">(${e.date||''})</span></li>`).join('') || '<li>暂无记录</li>';
  lbHint.textContent = fromGameOver ? `你的分数：${score} 分` : '显示本地前五名成绩';
  recapEl.innerHTML = fromGameOver ? `你在 <b>Level ${diedAtLevel} · ${levelRule}</b> 挂了｜最大连击：<b>${maxCombo}</b>｜金币：<b>${coinsGot}</b>` : '';
  const qualifies = fromGameOver && (lb.length<5 || score>lb[lb.length-1].score);
  lbInputWrap.style.display = qualifies ? '' : 'none';
  if (qualifies){ lbName.value=''; setTimeout(()=>lbName.focus(), 50); }
  menuCard.style.display='none'; lbCard.style.display=''; overlay.classList.add('show');
}
function saveToLeaderboard(name, sc){ const lb=loadLeaderboard(); lb.push({name, score:sc, date:formatDate()}); lb.sort((a,b)=>b.score-a.score); saveLeaderboard(lb); lbList.innerHTML = lb.map(e=>`<li><b>${e.name||'Player'}</b> — ${e.score} 分 <span style="opacity:.7">(${e.date||''})</span></li>`).join(''); }

/* Main loop */
function loop(ts){ if (!loop.last) loop.last=ts; const dt=Math.min(0.033,(ts-loop.last)/1000); loop.last=ts; perfNow=ts/1000; if (state==='play'){ update(dt); draw(); pPresent(); } else { pClear(); draw(); pPresent(); } requestAnimationFrame(loop); }

renderLives(); overlay.classList.add('show'); draw(); pPresent(); requestAnimationFrame(loop);
</script>
</body>
</html>
