<!doctype html>
<html lang="zh">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>å°æé¾™èº²æ°´æœ Â· åƒç´  v8.2 Â· è‡ªé€‚åº”ç”»å¸ƒ</title>
<style>
  html,body{height:100%;margin:0;background:#0c0f12;color:#eef;font-family:system-ui,-apple-system,Segoe UI,Roboto}
  .wrap{display:flex;align-items:center;justify-content:center;height:100%}
  canvas{background:#000;border:1px solid #222;box-shadow:0 10px 30px rgba(0,0,0,.65);touch-action:none}
  .tag{position:fixed;left:12px;top:12px;font-size:12px;opacity:.9;background:rgba(255,255,255,.05);border:1px solid #2a2f3a;padding:6px 8px;border-radius:10px}
  .hud{position:fixed;left:50%;top:10px;transform:translateX(-50%);display:flex;gap:14px;align-items:center;font-weight:800;letter-spacing:.3px}
  .btnbar{position:fixed;right:12px;top:10px;display:flex;gap:8px}
  .iconbtn{width:36px;height:36px;border-radius:10px;border:1px solid #2a2f3a;background:rgba(255,255,255,.06);display:grid;place-items:center;cursor:pointer;user-select:none}
  .meter{position:fixed;right:12px;top:56px;width:154px;height:10px;border:1px solid #2a2f3a;border-radius:8px;background:rgba(255,255,255,.06);overflow:hidden}
  .meter>i{display:block;height:100%;background:#6ce1ff;transform-origin:left center;transition:width .1s}
  .shieldbar{position:fixed;right:12px;top:74px;width:154px;height:10px;border:1px solid #2a2f3a;border-radius:8px;background:rgba(255,255,255,.06);overflow:hidden}
  .shieldbar>i{display:block;height:100%;background:#7dffa5;transform-origin:left center;transition:width .1s}
  .coins{position:fixed;right:12px;top:94px;font-weight:700;opacity:.95;background:rgba(255,255,255,.06);border:1px solid #2a2f3a;border-radius:10px;padding:4px 8px}
  .combo{position:fixed;left:50%;top:56px;transform:translateX(-50%);font-weight:900;font-size:20px;pointer-events:none;text-shadow:0 2px 8px rgba(0,0,0,.5);opacity:.95}
  .levelBanner{position:fixed;left:50%;top:40%;transform:translate(-50%,-50%) scale(.6);font-size:26px;font-weight:900;letter-spacing:.5px;background:rgba(0,0,0,.35);padding:10px 14px;border:1px solid #2a2f3a;border-radius:12px;opacity:0;transition:.28s}
  .tip{position:fixed;left:12px;bottom:12px;font-size:12px;opacity:.85}
  .overlay{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.55);visibility:hidden;opacity:0;transition:.2s}
  .show{visibility:visible;opacity:1}
  .card{background:#151a22;border:1px solid #2a2f3a;padding:16px 18px;border-radius:14px;text-align:center;max-width:92vw;color:#dfe7ff}
  .btn{display:inline-block;margin-top:10px;padding:10px 16px;border-radius:10px;border:1px solid #2a2f3a;background:#18202b;cursor:pointer;user-select:none}
  .small{opacity:.8;font-size:13px;margin-top:6px}
  .lb{position:fixed;right:12px;bottom:12px;font-size:12px;opacity:.95;background:rgba(255,255,255,.06);border:1px solid #2a2f3a;border-radius:10px;padding:6px 10px}
  .ach{position:fixed;left:12px;bottom:12px;font-size:12px;opacity:.95;background:rgba(255,255,255,.06);border:1px solid #2a2f3a;border-radius:10px;padding:6px 10px}
  input[type=text], select, input[type=range]{width:100%;box-sizing:border-box;padding:8px 10px;border-radius:10px;border:1px solid #2a2f3a;background:#10151d;color:#dfe7ff}
  .form-row{display:grid;grid-template-columns:120px 1fr;gap:10px;align-items:center;margin:8px 0}
  .hint{position:fixed;right:12px;bottom:64px;background:rgba(0,0,0,.55);border:1px solid #2a2f3a;border-radius:10px;padding:8px 10px;font-size:12px;opacity:.95}
  .mission{position:fixed;left:50%;bottom:54px;transform:translateX(-50%);background:rgba(0,0,0,.55);border:1px solid #2a2f3a;border-radius:10px;padding:6px 10px;font-size:12px;opacity:.95}
</style>
</head>
<body>
  <div class="tag">ğŸ¦– Dino & Fruits Â· åƒç´  v8.2ï¼ˆResponsiveï¼‰</div>

  <div class="hud">
    åˆ†æ•°ï¼š<span id="score">0</span>
    <span>Â· æœ€é«˜åˆ†ï¼š<span id="best">0</span></span>
    <span id="lives"></span>
  </div>

  <div class="btnbar">
    <div class="iconbtn" id="pauseBtn" title="æš‚åœ/ç»§ç»­">â¸ï¸</div>
    <div class="iconbtn" id="muteBtn" title="é™éŸ³/å¼€éŸ³">ğŸ”Š</div>
    <div class="iconbtn" id="gearBtn" title="è®¾ç½®">âš™ï¸</div>
  </div>

  <div class="meter" title="å†²åˆºå†·å´ï¼ˆShiftï¼‰"><i id="dashFill" style="width:100%"></i></div>
  <div class="shieldbar" title="æŠ¤ç›¾å‰©ä½™ï¼ˆæ‹¾å–ç›¾ç‰Œï¼‰"><i id="shieldFill" style="width:0%"></i></div>
  <div class="coins" title="é‡‘å¸ï¼ˆ+5åˆ†ï¼‰">ğŸª™ x <span id="coinCnt">0</span></div>

  <div id="comboEl" class="combo"></div>
  <div id="banner" class="levelBanner"></div>
  <div id="tip" class="tip"></div>
  <div id="lbBtn" class="lb" title="æŸ¥çœ‹æ’è¡Œæ¦œ">ğŸ† æ’è¡Œæ¦œ</div>
  <div id="achBtn" class="ach" title="æŸ¥çœ‹æˆå°±">ğŸ– æˆå°±</div>
  <div id="firstHint" class="hint" style="display:none"></div>
  <div id="missionBar" class="mission" style="display:none"></div>

  <div class="wrap"><canvas id="game" width="520" height="820"></canvas></div>

  <!-- èœå• / æ’è¡Œæ¦œ / è®¾ç½® / æˆå°± -->
  <div id="overlay" class="overlay">
    <div class="card" id="menuCard">
      <h2 style="margin:6px 0 6px">å°æé¾™èº²æ°´æœ Â· åƒç´ è¿›é˜¶</h2>
      <div id="msg">
        æ¯ 30 ç§’å‡ä¸€å…³å¹¶åˆ‡æ¢è§„åˆ™ï¼šGold Rush / Bomb Storm / Ice Age / Heavy Rain / Reverse Controls / Speed Upã€‚<br>
        ğŸª™ é‡‘å¸ +5 Â· â„ï¸ é›ªèŠ± å†»ç»“ Â· ğŸ›¡ ç›¾ç‰Œ æŠ¤ä½“ Â· ğŸ’£ ç‚¸å¼¹ å±é™©ã€‚å†²åˆºå¯æ‰“å‡ºè¿å‡»ï¼å®Œæˆæ¯å…³ä»»åŠ¡æ‹¿å¥–åŠ±ã€‚
      </div>
      <div class="small">R é‡å¼€ Â· ç©ºæ ¼æš‚åœ/ç»§ç»­ Â· æ‰‹æœºå·¦å³æ‹–æ‹½ Â· ç‚¹å¼€å§‹æ’­æ”¾BGM</div>
      <div class="btn" id="start">å¼€å§‹æ¸¸æˆ</div>
    </div>

    <div class="card" id="lbCard" style="display:none;text-align:left;max-width:560px">
      <h3 style="margin:6px 0 10px">ğŸ† æœ¬åœ°æ’è¡Œæ¦œï¼ˆTop 5ï¼‰</h3>
      <ol id="lbList" style="margin:0 0 10px 20px;padding:0"></ol>
      <div id="lbHint" style="opacity:.85;margin-bottom:8px"></div>
      <div id="recap" style="opacity:.95;margin:8px 0"></div>
      <div id="lbInputWrap" style="display:none;margin-top:6px">
        <div style="margin:6px 0">ä½ çš„åå­—ï¼š</div>
        <input type="text" id="lbName" maxlength="16" placeholder="è¾“å…¥æ˜µç§°"/>
        <button class="btn" id="lbSave">ä¿å­˜æˆç»©</button>
      </div>
      <div style="margin-top:8px"><button class="btn" id="lbClose">å…³é—­</button></div>
    </div>

    <div class="card" id="settingsCard" style="display:none;text-align:left;max-width:560px">
      <h3 style="margin:6px 0 10px">âš™ï¸ è®¾ç½®</h3>
      <div class="form-row"><label>éŸ³é‡</label><input type="range" id="vol" min="0" max="100" step="1"></div>
      <div class="form-row"><label>éŸ³ä¹</label><select id="music"><option value="on">å¼€å¯</option><option value="off">å…³é—­</option></select></div>
      <div class="form-row"><label>éŸ³æ•ˆé£æ ¼</label><select id="sfx"><option value="pixel">åƒç´ éŸ³ï¼ˆ8-bitï¼‰</option><option value="hifi">é«˜ä¿çœŸ</option></select></div>
      <div class="form-row"><label>BGM é£æ ¼</label><select id="bgmStyle"><option value="chiptune">Chiptune</option><option value="synthwave">Synthwave</option><option value="lofi">Lo-Fi</option></select></div>
      <div class="form-row"><label>åƒç´ é¢—ç²’</label><select id="px"><option value="1">æ¸…æ™°ï¼ˆ1xï¼‰</option><option value="0.5">åƒç´ ï¼ˆ2xï¼‰</option><option value="0.33">ç²—åƒç´ ï¼ˆ3xï¼‰</option></select></div>
      <div class="form-row"><label>è‰²å¼±æ¨¡å¼</label><select id="cb"><option value="off">å…³é—­</option><option value="on">å¯ç”¨ï¼ˆé«˜å¯¹æ¯”+æè¾¹ï¼‰</option></select></div>
      <div class="form-row"><label>é¦–æ¬¡å¼•å¯¼</label><select id="hints"><option value="on">å¼€å¯</option><option value="off">å…³é—­</option></select></div>
      <div style="display:flex;gap:8px;margin-top:10px"><button class="btn" id="saveSettings">ä¿å­˜</button><button class="btn" id="cancelSettings">å–æ¶ˆ</button></div>
    </div>

    <div class="card" id="achCard" style="display:none;text-align:left;max-width:560px">
      <h3 style="margin:6px 0 10px">ğŸ– æˆå°±</h3>
      <ul id="achList" style="margin:0 0 10px 18px;padding:0;line-height:1.7"></ul>
      <div style="margin-top:8px"><button class="btn" id="achClose">å…³é—­</button></div>
    </div>
  </div>

<script>
/* ================ Settings ================ */
const SETTINGS_KEY='dino_settings_v2';
let settings = loadSettings();
function loadSettings(){
  try{
    const s = JSON.parse(localStorage.getItem(SETTINGS_KEY)||'{}');
    return { volume:s.volume??28, music:s.music??'on', sfx:s.sfx??'pixel', bgm:s.bgm??'chiptune', px:s.px??0.5, cb:s.cb??'off', hints:s.hints??true };
  }catch(e){ return {volume:28,music:'on',sfx:'pixel',bgm:'chiptune',px:0.5,cb:'off',hints:true}; }
}
function saveSettings(){ localStorage.setItem(SETTINGS_KEY, JSON.stringify(settings)); }

/* ===== Pixel Canvas ===== */
const canvas = document.getElementById('game');
const mc = canvas.getContext('2d');
let W = canvas.width, H = canvas.height;
let pcanvas, c;
function pInitCanvas(){
  pcanvas = document.createElement('canvas');
  pcanvas.width = Math.max(Math.round(W*settings.px), 160);
  pcanvas.height= Math.max(Math.round(H*settings.px), 240);
  c = pcanvas.getContext('2d'); c.imageSmoothingEnabled=false; mc.imageSmoothingEnabled=false;
}
pInitCanvas();

/* ===== UI refs ===== */
const scoreEl=document.getElementById('score'), bestEl=document.getElementById('best'), livesEl=document.getElementById('lives');
const overlay=document.getElementById('overlay'), startBtn=document.getElementById('start'), msgEl=document.getElementById('msg');
const pauseBtn=document.getElementById('pauseBtn'), muteBtn=document.getElementById('muteBtn'), gearBtn=document.getElementById('gearBtn');
const dashFill=document.getElementById('dashFill'), shieldFill=document.getElementById('shieldFill'), comboEl=document.getElementById('comboEl');
const tipEl=document.getElementById('tip'), bannerEl=document.getElementById('banner'), lbBtn=document.getElementById('lbBtn');
const achBtn=document.getElementById('achBtn'), menuCard=document.getElementById('menuCard'), lbCard=document.getElementById('lbCard');
const lbList=document.getElementById('lbList'), lbHint=document.getElementById('lbHint'), recapEl=document.getElementById('recap');
const lbInputWrap=document.getElementById('lbInputWrap'), lbName=document.getElementById('lbName'), lbSave=document.getElementById('lbSave'), lbClose=document.getElementById('lbClose');
const achCard=document.getElementById('achCard'), achClose=document.getElementById('achClose'), achList=document.getElementById('achList');
const coinCntEl=document.getElementById('coinCnt'), firstHintEl=document.getElementById('firstHint'), missionBar=document.getElementById('missionBar');

/* Settings é¢æ¿ */
const settingsCard=document.getElementById('settingsCard');
const volSel=document.getElementById('vol'), musicSel=document.getElementById('music'), sfxSel=document.getElementById('sfx'), bgmStyleSel=document.getElementById('bgmStyle');
const pxSel=document.getElementById('px'), cbSel=document.getElementById('cb'), hintsSel=document.getElementById('hints');
const saveSettingsBtn=document.getElementById('saveSettings'), cancelSettingsBtn=document.getElementById('cancelSettings');

/* ===== State ===== */
let keys=new Set(), pointerX=null, state='menu';
let score=0, time=0, spawnTimer=0, powerTimer=0, coinTimer=0, bombTimer=0, iceTimer=0;
let best=Number(localStorage.getItem('dino_highscore_v8')||0); bestEl.textContent=best;
let lives=3, invincible=0, blink=0;
let dashing=0, dashCooldown=0; const DASH_DURATION=0.35, DASH_COOLDOWN=3.0;
let shield=0; const SHIELD_GAIN=5.0;
let combo=0, comboTimer=0; const COMBO_WINDOW=1.2;
let rainy=Math.random()<0.25, freezeAll=0;
let level=1, levelClock=0, levelRule='Normal'; const LEVEL_LEN=30; const RULES=['Gold Rush','Bomb Storm','Ice Age','Heavy Rain','Reverse Controls','Speed Up'];

/* ç»Ÿè®¡ & æˆå°± */
let maxCombo=0, coinsGot=0, diedAtLevel=1;
let firstSeen={coin:false,ice:false,shield:false,bomb:false};
let safeBombsRun=0, freezesUsedRun=0;

/* ===== æˆå°±ç³»ç»Ÿ ===== */
const ACH_KEY='dino_achievements_v1';
let achievements=loadAchievements();
function loadAchievements(){ try{ return JSON.parse(localStorage.getItem(ACH_KEY)||'{}')||{}; }catch(e){ return {}; } }
function saveAchievements(){ localStorage.setItem(ACH_KEY, JSON.stringify(achievements)); }
function unlockAch(key,label){ if(achievements[key]) return; achievements[key]={label, date:new Date().toISOString().slice(0,10)}; saveAchievements(); tip(`ğŸ– è§£é”æˆå°±ï¼š${label}`); }
function refreshAchList(){
  const defs=[['first_coin','ç¬¬ä¸€æ¬¡æ¡åˆ°é‡‘å¸'],['combo_5','æ‰“å‡º 5 è¿å‡»'],['combo_10','æ‰“å‡º 10 è¿å‡»'],['level_5','åˆ°è¾¾å…³å¡ 5'],['level_10','åˆ°è¾¾å…³å¡ 10'],['mission_first','å®Œæˆç¬¬ä¸€æ¡å…³å¡ä»»åŠ¡'],['freeze_5','ç´¯è®¡è§¦å‘ 5 æ¬¡å†°å†»'],['bombtech_5','ç´¯è®¡å®‰å…¨å¼•çˆ† 5 æšç‚¸å¼¹']];
  achList.innerHTML = defs.map(([k,txt])=>`${achievements[k]?'âœ…':'â¬œï¸'} ${txt} ${achievements[k]?`<span style="opacity:.7">(${achievements[k].date})</span>`:''}`).map(li=>`<li>${li}</li>`).join('');
}

/* ===== å±€å†…ä»»åŠ¡ ===== */
let mission=null, bestComboThisLevel=0, coinsThisLevel=0;
function rollMission(){ const t=(level%2===1)?'combo3':'coins10'; mission=(t==='combo3')?{type:'combo3',goal:3,progress:0,done:false}:{type:'coins10',goal:10,progress:0,done:false}; bestComboThisLevel=0; coinsThisLevel=0; updateMissionUI(); }
function updateMissionUI(){ if(!mission){ missionBar.style.display='none'; return; } missionBar.textContent = mission.done?`âœ… ä»»åŠ¡å®Œæˆï¼å¥–åŠ±å·²å‘æ”¾`:(mission.type==='combo3'?`ğŸ¯ æœ¬å…³ä»»åŠ¡ï¼šè¾¾æˆ ${mission.goal} è¿å‡»ï¼ˆå½“å‰ ${Math.min(bestComboThisLevel,mission.goal)}/${mission.goal}ï¼‰`:`ğŸ¯ æœ¬å…³ä»»åŠ¡ï¼šæ”¶é›† ${mission.goal} æšé‡‘å¸ï¼ˆå½“å‰ ${Math.min(coinsThisLevel,mission.goal)}/${mission.goal}ï¼‰`); missionBar.style.display=''; }
function tryFinishMission(){ if(!mission||mission.done)return; if((mission.type==='combo3'&&bestComboThisLevel>=mission.goal)||(mission.type==='coins10'&&coinsThisLevel>=mission.goal)) onMissionComplete(); }
function onMissionComplete(){ mission.done=true; addScore(20,true); shield+=2.0; tip('âœ… ä»»åŠ¡å®Œæˆï¼š+20 åˆ† & ä¸´æ—¶æŠ¤ç›¾'); unlockAch('mission_first','å®Œæˆç¬¬ä¸€æ¡å…³å¡ä»»åŠ¡'); updateMissionUI(); }

/* ===== Audioï¼ˆå«å¤šé£æ ¼BGMï¼‰ ===== */
let audioCtx=null, masterGain=null, bgmTimer=null, muted=false;
function initAudio(){ if(audioCtx) return; audioCtx=new (window.AudioContext||window.webkitAudioContext)(); masterGain=audioCtx.createGain(); setVolume(settings.volume); masterGain.connect(audioCtx.destination); }
function setVolume(v){ if(!masterGain) return; masterGain.gain.value=(v/100)*0.9; }
function playTone(freq,dur,type,vol){ if(!audioCtx||muted) return; if(settings.sfx==='pixel'){ tone(freq,dur,type||'square',vol??0.22); } else { tone(freq,dur*1.1,'sine',(vol??0.22)*0.9); tone(freq*2,dur*0.8,'triangle',(vol??0.22)*0.35); setTimeout(()=>tone(freq*0.5,dur*0.6,'sine',(vol??0.22)*0.25),30); } }
function tone(freq,dur=0.12,type='sine',vol=0.5){ if(!audioCtx||muted) return; const o=audioCtx.createOscillator(), g=audioCtx.createGain(); o.type=type; o.frequency.value=freq; g.gain.value=0; o.connect(g); g.connect(masterGain); const t=audioCtx.currentTime; g.gain.linearRampToValueAtTime(0,t); g.gain.linearRampToValueAtTime(vol,t+0.005); g.gain.exponentialRampToValueAtTime(0.0001,t+dur); o.start(t); o.stop(t+dur+0.02); }
function sfxScore(){ playTone(900,0.08,'square',0.18); } function sfxHit(){ playTone(160,0.25,'sawtooth',0.22); playTone(100,0.25,'square',0.15);} function sfxBest(){ playTone(1244.5,0.18,'square',0.22); playTone(1661.2,0.18,'square',0.12);} function sfxShield(){ playTone(660,0.16,'triangle',0.22); playTone(990,0.12,'sine',0.18);} function sfxDash(){ playTone(520,0.12,'sawtooth',0.22); playTone(740,0.10,'square',0.12);} function sfxCombo(k){ playTone(900+60*k,0.09,'square',0.22);} function sfxCoin(){ playTone(880,0.08,'triangle',0.22); playTone(1320,0.12,'sine',0.22);} function sfxIce(){ playTone(520,0.16,'triangle',0.2); playTone(380,0.22,'sine',0.12);} function sfxBomb(){ playTone(160,0.18,'square',0.24); playTone(90,0.24,'sawtooth',0.22); }
function startBGM(){ if(!audioCtx||muted||settings.music==='off') return; stopBGM(); const style=settings.bgm; if(style==='chiptune') chiptuneLoop(); else if(style==='synthwave') synthwaveLoop(); else lofiLoop();
  function chiptuneLoop(){ const bpm=116, beat=60/bpm; const scale=[261.63,293.66,329.63,349.23,392,440,493.88,523.25]; let i=0; bgmTimer=setInterval(()=>{ const root=scale[[0,2,4,5][Math.floor(i/4)%4]]; playTone(root/2, beat*0.9,'triangle',0.12); let bonus=combo>0?Math.min(6,Math.floor(combo/3)):0; const melody=[0,2,4,5,4,2,0,2, 4,5,7,5,4,2,0, -1,0,2,4,5,4,2,0, 2,4,5,7,9,7,5,4]; const note=scale[(melody[i%melody.length]+8+bonus)%8]||root; playTone(note,beat*0.45,'square',0.16); i++; }, (beat/2)*1000); }
  function synthwaveLoop(){ const bpm=92, beat=60/bpm; const root=110; let i=0; bgmTimer=setInterval(()=>{ playTone(root, beat*1.2,'sawtooth',0.12); if(i%2===0) playTone(root*1.5, beat*0.8,'triangle',0.08); const seq=[0,3,5,7,5,3,0,3, 5,7,8,7,5,3,0]; const n=seq[i%seq.length]; playTone(root*Math.pow(2,n/12), beat*0.6,'sine',0.14); i++; }, beat*1000); }
  function lofiLoop(){ const bpm=80, beat=60/bpm; let i=0; bgmTimer=setInterval(()=>{ playTone(196, beat*1.0,'sine',0.08); if(i%4===0) playTone(392, beat*0.6,'triangle',0.06); if(Math.random()<0.5) playTone(261.63*(1+Math.random()*0.1), beat*0.35,'sine',0.06); i++; }, beat*1000); }
}
function stopBGM(){ if(bgmTimer){ clearInterval(bgmTimer); bgmTimer=null; } }

/* ===== HUD ===== */
function renderLives(){ let hearts=''; for(let i=0;i<lives;i++) hearts+='â¤ï¸'; livesEl.textContent=`Â· ç”Ÿå‘½ï¼š${hearts||'â€”'}`; }
function addScore(n){ score+=n; scoreEl.textContent=score; scoreEl.style.transform='scale(1.08)'; setTimeout(()=>scoreEl.style.transform='scale(1)',90); sfxScore(); if(score>best){ best=score; bestEl.textContent=best; localStorage.setItem('dino_highscore_v8',best); sfxBest(); } }

/* ===== Pixel helpers ===== */
function pClear(){ c.setTransform(1,0,0,1,0,0); c.clearRect(0,0,pcanvas.width,pcanvas.height); c.setTransform(1,0,0,1,0,0); }
function pPresent(){ mc.clearRect(0,0,W,H); mc.imageSmoothingEnabled=false; mc.drawImage(pcanvas,0,0,W,H); }
function pixRect(x,y,w,h,col='#fff',alpha=1){ c.globalAlpha=alpha; c.fillStyle=col; c.fillRect((x*settings.px)|0,(y*settings.px)|0,Math.max(1,(w*settings.px)|0),Math.max(1,(h*settings.px)|0)); c.globalAlpha=1; }
function pixCircle(x,y,r,col='#fff',alpha=1){ c.globalAlpha=alpha; c.fillStyle=col; c.beginPath(); c.arc((x*settings.px),(y*settings.px),(r*settings.px),0,Math.PI*2); c.fill(); c.globalAlpha=1; }
function pixText(x,y,txt,size=16,col='#fff'){ c.fillStyle=col; c.font=`bold ${(size*settings.px)}px system-ui`; c.fillText(txt,(x*settings.px)|0,(y*settings.px)|0); }
function pixOutlineRect(x,y,w,h,col='#000'){ pixRect(x-2,y-2,w+4,2,col); pixRect(x-2,y+h,w+4,2,col); pixRect(x-2,y,2,h,col); pixRect(x+w,y,2,h,col); }
function pixOutlineCircle(x,y,r,col='#000'){ pixCircle(x,y,r+2,col,0.9); }

/* ===== Dino ===== */
const dino={x:W/2,y:H-110,w:54,h:32,speed:4.6,vx:0};
function drawDino(){
  pixCircle(dino.x,dino.y+18,16,'rgba(0,0,0,.28)');
  const flashing=invincible>0||dashing>0; const alpha=(flashing&&Math.floor(perfNow*20)%2===0)?0.55:1;
  if(shield>0) pixCircle(dino.x,dino.y-2,44+2*Math.sin(perfNow*4),'rgba(125,255,165,.35)');
  const bodyCol=settings.cb==='on'?'#33e07c':`rgba(62,207,107,${alpha})`;
  pixRect(dino.x-32,dino.y-18,68,32,bodyCol); pixRect(dino.x-10,dino.y-6,40,18,settings.cb==='on'?'#ffffff':'#e8fff1');
  pixRect(dino.x+24,dino.y-26,24,20,bodyCol); pixRect(dino.x+48,dino.y-18,14,8,bodyCol);
  pixRect(dino.x-6,dino.y-4,8,3,bodyCol); pixRect(dino.x-32,dino.y-8,20,10,bodyCol);
  pixRect(dino.x-12,dino.y+12,12,6,'#c7f7da'); pixRect(dino.x+6,dino.y+12,12,6,'#c7f7da');
  if(blink>0 && blink<0.12) pixRect(dino.x+40,dino.y-17,6,2,'#0b0c10'); else pixRect(dino.x+41,dino.y-20,4,4,'#0b0c10');
  if(dashing>0) pixRect(dino.x-32-10*Math.sign(dino.vx||1),dino.y-18,68,32,'rgba(169,255,209,.14)');
}

/* ===== Fruits & Items ===== */
const FRUIT_TYPES=[
  {name:'apple',w:[26,34],h:20,col:'#ff6b6b',draw:b=>{ fruitShadow(b); if(settings.cb==='on') pixOutlineRect(b.x-1,b.y-1,b.w+2,b.h+2,'#000'); pixRect(b.x,b.y,b.w,b.h,b.col); pixRect(b.x+b.w*0.7,b.y-2,6,4,'#6ad66a'); }},
  {name:'banana',w:[30,44],h:12,col:'#ffd166',draw:b=>{ fruitShadow(b); if(settings.cb==='on') pixOutlineRect(b.x-1,b.y+1,b.w+2,6,'#000'); pixRect(b.x,b.y+4,b.w,4,b.col); pixRect(b.x+4,b.y+2,b.w-8,4,b.col); }},
  {name:'orange',w:[24,30],h:24,col:'#ffa62b',draw:b=>{ fruitShadow(b); if(settings.cb==='on') pixOutlineCircle(b.x+b.w/2,b.y+b.h/2,b.w/2+3,'#000'); pixCircle(b.x+b.w/2,b.y+b.h/2,b.w/2,b.col); pixRect(b.x+b.w/2-1,b.y-3,2,6,'#5ec27f'); }},
  {name:'grape',w:[26,32],h:26,col:(settings.cb==='on'?'#b66cf0':'#9b5de5'),draw:b=>{ fruitShadow(b); for(let i=0;i<6;i++){ const row=i>>1,col=i%3-1; pixCircle(b.x+b.w/2+col*6,b.y+b.h/2+(row-0.5)*6,6,b.col);} pixRect(b.x+b.w/2-1,b.y-4,2,6,'#6ad66a'); }},
  {name:'watermelon',w:[32,46],h:20,col:(settings.cb==='on'?'#ff3f7a':'#ff5c8a'),draw:b=>{ fruitShadow(b); pixRect(b.x,b.y+b.h-6,b.w,6,'#2dd38a'); if(settings.cb==='on') pixOutlineRect(b.x,b.y+b.h-14,b.w,8,'#000'); pixRect(b.x,b.y+b.h-14,b.w,8,b.col); }},
];
function fruitShadow(b){ pixCircle(b.x+b.w/2,b.y+b.h+6,Math.max(6,b.w*.45),'rgba(0,0,0,.28)'); }
function drawCoin(t){ fruitShadow({x:t.x,y:t.y,w:t.w,h:t.h}); if(settings.cb==='on') pixOutlineCircle(t.x+t.w/2,t.y+t.h/2,t.w/2+6,'#000'); pixCircle(t.x+t.w/2,t.y+t.h/2,t.w/2+2,'#f4d35e'); pixCircle(t.x+t.w/2,t.y+t.h/2,t.w/2-4,'#ffe28a'); pixText(t.x+t.w/2-6,t.y+t.h/2+4,(Math.random()<.5?'Â¥':'$'),16,'#5c3b00'); }
function drawSnow(p){ const cx=p.x+p.w/2,cy=p.y+p.h/2; if(settings.cb==='on') pixOutlineCircle(cx,cy,p.w/2+6,'#000'); pixCircle(cx,cy,p.w/2+6,'rgba(160,210,255,.12)'); pixRect(cx-1,cy-8,2,16,'#aee7ff'); pixRect(cx-8,cy-1,16,2,'#aee7ff'); pixRect(cx-6,cy-6,12,2,'#aee7ff'); pixRect(cx-6,cy+4,12,2,'#aee7ff'); }
function drawShieldItem(b){ const cx=b.x+b.w/2,cy=b.y+b.h/2; if(settings.cb==='on') pixOutlineRect(cx-11,cy-9,22,18,'#000'); pixRect(cx-10,cy-8,20,16,'rgba(67,245,143,1)'); pixRect(cx-8,cy-6,16,12,'rgba(10,30,16,0.22)'); }
function drawBomb(b){ fruitShadow({x:b.x,y:b.y,w:b.w,h:b.h}); if(settings.cb==='on') pixOutlineCircle(b.x+b.w/2,b.y+b.h/2,b.w/2+4,'#000'); pixCircle(b.x+b.w/2,b.y+b.h/2,b.w/2,'#222'); pixRect(b.x+b.w/2-1,b.y-10,2,10,'#555'); pixCircle(b.x+b.w/2+8,b.y-12,6,'rgba(255,207,90,.9)'); }

/* ===== Spawners ===== */
const rnd=(a,b)=>Math.random()*(b-a)+a;
let fruits=[],powers=[],coins=[],bombs=[],particles=[],floatTexts=[];
function spawnFruit(){ const t=FRUIT_TYPES[Math.floor(rnd(0,FRUIT_TYPES.length))]; const w=rnd(t.w[0],t.w[1]),h=t.h; const x=rnd(6,W-w-6),y=-30; let vy=rnd(2.3,3.8)+Math.min(time/28,3.4); if(rainy||levelRule==='Heavy Rain') vy+=0.8; if(freezeAll>0) vy*=0.2; fruits.push({type:t,x,y,w,h,vy,col:t.col}); }
function spawnShield(){ const w=26,h=26,x=rnd(10,W-10-w),y=-30; let vy=(freezeAll>0?0.8:1)*(rnd(2.0,3.2)+Math.min(time/35,2.2)); powers.push({kind:'shield',x,y,w,h,vy}); }
function spawnSnow(){ const w=28,h=28,x=rnd(10,W-10-w),y=-30; let vy=(freezeAll>0?0.8:1)*(rnd(2.0,3.0)+Math.min(time/40,2.0)); powers.push({kind:'ice',x,y,w,h,vy}); }
function spawnCoin(){ const w=26,h=26,x=rnd(10,W-10-w),y=-30; let vy=rnd(2.6,3.8)+Math.min(time/30,2.6); if(freezeAll>0) vy*=0.2; coins.push({x,y,w,h,vy}); }
function spawnBomb(){ const w=26,h=26,x=rnd(10,W-10-w),y=-30; let vy=rnd(2.6,4.2)+Math.min(time/28,3.0); if(freezeAll>0) vy*=0.2; bombs.push({x,y,w,h,vy}); }

/* ===== èƒŒæ™¯ ===== */
function drawParallax(){
  const t=(Math.sin(perfNow/12)+1)/2;
  const top=lerpColor([22,28,58],[4,8,20],t), bot=lerpColor([120,170,255],[30,40,70],t);
  const grd=c.createLinearGradient(0,0,0,pcanvas.height); grd.addColorStop(0,`rgb(${top[0]},${top[1]},${top[2]})`); grd.addColorStop(1,`rgb(${bot[0]},${bot[1]},${bot[2]})`);
  c.fillStyle=grd; c.fillRect(0,0,pcanvas.width,pcanvas.height);
  c.fillStyle='rgba(40,60,100,.95)'; drawHills(0.25,70);
  c.fillStyle='rgba(60,80,120,.9)'; drawHills(0.15,40);
  c.fillStyle='rgba(255,255,255,.28)'; for(let i=0;i<5;i++){ const x=((i*180+(perfNow*20))%(W+220))-110; const y=80+(i%3)*30; drawCloud(x,y,70+i*6); }
  pixRect(0,H-80,W,80,'#1b2e1e'); pixRect(0,H-64,W,64,'#284a2e'); for(let x=0;x<W;x+=14) pixRect(x,H-64,2,8+3*Math.sin((x+perfNow*40)/20),'rgba(0,0,0,.22)');
  let tint=null; if(levelRule==='Ice Age') tint='rgba(120,180,255,.12)'; else if(levelRule==='Heavy Rain') tint='rgba(150,170,190,.12)'; else if(levelRule==='Gold Rush') tint='rgba(255,210,120,.10)'; if(tint) pixRect(0,0,W,H,tint);
}
function drawHills(speed,baseY){ c.beginPath(); for(let x=0;x<=pcanvas.width;x+=5){ const sx=x/settings.px, y=H-120-baseY-18*Math.sin((sx*0.01)+(perfNow*speed)); const px=(x)|0, py=((y*settings.px)|0); x===0?c.moveTo(px,py):c.lineTo(px,py);} c.lineTo(pcanvas.width,pcanvas.height); c.lineTo(0,pcanvas.height); c.closePath(); c.fill(); }
function drawCloud(x,y,w){ pixCircle(x,y,w*0.8,'rgba(255,255,255,.25)'); pixCircle(x+w*0.35,y+6,w*0.56,'rgba(255,255,255,.25)'); pixCircle(x-w*0.35,y+10,w*0.56,'rgba(255,255,255,.25)'); }
function lerpColor(a,b,t){ return [Math.round(a[0]+(b[0]-a[0])*t),Math.round(a[1]+(b[1]-a[1])*t),Math.round(a[2]+(b[2]-a[2])*t)]; }

/* ===== ç²’å­/é£˜å­— ===== */
function splash(x,y,col='#9ad',n=14){ for(let i=0;i<n;i++) particles.push({x,y,vx:rnd(-2,2),vy:rnd(-3,0),r:rnd(1,2.6),col,life:1}); }
function floatText(x,y,txt,col='#fff'){ floatTexts.push({x,y,txt,col,life:1}); }
function drawParticles(){ for(let i=particles.length-1;i>=0;i--){ const p=particles[i]; p.x+=p.vx; p.y+=p.vy; p.vy+=0.1; p.life-=0.016; if(p.life<=0) particles.splice(i,1);} particles.forEach(p=>pixCircle(p.x,p.y,p.r,p.col,Math.max(0,p.life))); }
function drawFloatTexts(){ floatTexts.forEach(ft=>{ ft.y-=0.6; ft.life-=0.02; c.globalAlpha=Math.max(0,ft.life); pixText(ft.x,ft.y,ft.txt,18,ft.col); c.globalAlpha=1; }); floatTexts=floatTexts.filter(ft=>ft.life>0); }

/* ===== Banner ===== */
function showBanner(text){ bannerEl.textContent=text; bannerEl.style.opacity=1; bannerEl.style.transform='translate(-50%,-50%) scale(.6)'; for(let i=0;i<28;i++) splash(W/2+rnd(-40,40),H*0.4+rnd(-12,12),'#ffd166',1); setTimeout(()=>{ bannerEl.style.transform='translate(-50%,-50%) scale(1)'; },10); setTimeout(()=>{ bannerEl.style.opacity=0; },1600); }

/* ===== Input ===== */
document.addEventListener('keydown',e=>{ if(e.key==='r'||e.key==='R'){ startGame(); return; } if(e.key===' '){ togglePause(); return; } keys.add(e.key); if((e.key==='Shift'||e.key==='ShiftLeft'||e.key==='ShiftRight')&&settings.hints){ hideFirstHint(); }});
document.addEventListener('keyup',e=>keys.delete(e.key));
const touch=x=>{ const rect=canvas.getBoundingClientRect(); pointerX=x-rect.left; if(settings.hints) hideFirstHint(); };
canvas.addEventListener('pointerdown',e=>touch(e.clientX)); canvas.addEventListener('pointermove',e=>{ if(e.buttons) touch(e.clientX); }); window.addEventListener('pointerup',()=>{ pointerX=null; });

/* ===== æ’è¡Œæ¦œ ===== */
const lbKey='dino_lb_top5';
function loadLeaderboard(){ try{ const a=JSON.parse(localStorage.getItem(lbKey)||'[]'); return Array.isArray(a)?a:[]; }catch(e){ return []; } }
function saveLeaderboard(arr){ localStorage.setItem(lbKey, JSON.stringify(arr.slice(0,5))); }
function formatDate(){ const d=new Date(); const mm=String(d.getMonth()+1).padStart(2,'0'); const dd=String(d.getDate()).padStart(2,'0'); return `${mm}-${dd}`; }
function showLeaderboard(fromOver){ const lb=loadLeaderboard(); lbList.innerHTML = lb.map(e=>`<li><b>${e.name||'Player'}</b> â€” ${e.score} åˆ† <span style="opacity:.7">(${e.date||''})</span></li>`).join('') || '<li>æš‚æ— è®°å½•</li>'; lbHint.textContent=fromOver?`ä½ çš„åˆ†æ•°ï¼š${score} åˆ†`:'æ˜¾ç¤ºæœ¬åœ°å‰äº”åæˆç»©'; recapEl.innerHTML=fromOver?`ä½ åœ¨ <b>Level ${diedAtLevel} Â· ${levelRule}</b> æŒ‚äº†ï½œæœ€å¤§è¿å‡»ï¼š<b>${maxCombo}</b>ï½œé‡‘å¸ï¼š<b>${coinsGot}</b>`:''; const qualifies=fromOver&&(lb.length<5||score>lb[lb.length-1].score); lbInputWrap.style.display=qualifies?'':'none'; if(qualifies){ lbName.value=''; setTimeout(()=>lbName.focus(),50);} menuCard.style.display='none'; lbCard.style.display=''; achCard.style.display='none'; overlay.classList.add('show'); }
function saveToLeaderboard(name,sc){ const lb=loadLeaderboard(); lb.push({name,score:sc,date:formatDate()}); lb.sort((a,b)=>b.score-a.score); saveLeaderboard(lb); lbList.innerHTML = lb.map(e=>`<li><b>${e.name||'Player'}</b> â€” ${e.score} åˆ† <span style="opacity:.7">(${e.date||''})</span></li>`).join(''); }

/* ===== æˆå°±é¢æ¿ ===== */
function openAch(){ refreshAchList(); menuCard.style.display='none'; lbCard.style.display='none'; achCard.style.display=''; overlay.classList.add('show'); }
achBtn.addEventListener('click',openAch);
achClose.addEventListener('click',()=>{ achCard.style.display='none'; if(state!=='menu') overlay.classList.remove('show'); else menuCard.style.display=''; });

/* ===== Settings é¢æ¿ ===== */
function openSettings(){ volSel.value=settings.volume; musicSel.value=settings.music; sfxSel.value=settings.sfx; bgmStyleSel.value=settings.bgm; pxSel.value=String(settings.px); cbSel.value=settings.cb; hintsSel.value=settings.hints?'on':'off'; menuCard.style.display='none'; lbCard.style.display='none'; achCard.style.display='none'; settingsCard.style.display=''; overlay.classList.add('show'); }
function closeSettings(){ settingsCard.style.display='none'; if(state!=='menu') overlay.classList.remove('show'); else menuCard.style.display=''; }
saveSettingsBtn.addEventListener('click',()=>{ settings.volume=Number(volSel.value); settings.music=musicSel.value; settings.sfx=sfxSel.value; settings.bgm=bgmStyleSel.value; settings.px=Number(pxSel.value); settings.cb=cbSel.value; settings.hints=(hintsSel.value==='on'); saveSettings(); if(!audioCtx) initAudio(); setVolume(settings.volume); stopBGM(); if(state==='play'&&!muted) startBGM(); pInitCanvas(); initRain(); clampAll(); closeSettings(); });
cancelSettingsBtn.addEventListener('click',closeSettings);

/* ===== Buttons ===== */
startBtn.addEventListener('click',()=>{ initAudio(); audioCtx.resume(); startGame(); });
pauseBtn.addEventListener('click',()=>togglePause());
muteBtn.addEventListener('click',()=>{ muted=!muted; muteBtn.textContent=muted?'ğŸ”‡':'ğŸ”Š'; if(muted) stopBGM(); else startBGM(); });
gearBtn.addEventListener('click',openSettings);
lbBtn.addEventListener('click',()=>showLeaderboard(false));
lbClose.addEventListener('click',()=>{ menuCard.style.display=''; lbCard.style.display='none'; if(state!=='menu') overlay.classList.remove('show'); });
lbSave.addEventListener('click',()=>{ const name=(lbName.value||'Player').trim().slice(0,16); saveToLeaderboard(name,score); showLeaderboard(false); lbInputWrap.style.display='none'; });

/* ===== Game flow ===== */
function reset(){
  dino.x=W/2; dino.y=H-110; dino.vx=0;
  fruits.length=0; powers.length=0; coins.length=0; bombs.length=0; particles.length=0; floatTexts.length=0;
  spawnTimer=0; powerTimer=rnd(2.0,3.4); coinTimer=rnd(3.0,5.0); bombTimer=rnd(2.4,4.0); iceTimer=rnd(4.0,6.0);
  score=0; time=0; lives=3; invincible=0; blink=0; dashing=0; dashCooldown=0; shield=0; combo=0; comboTimer=0;
  scoreEl.textContent='0'; renderLives(); dashFill.style.width='100%'; shieldFill.style.width='0%';
  rainy=Math.random()<0.25; freezeAll=0; level=1; levelClock=0; levelRule='Normal'; showBanner('LEVEL 1 Â· Normal'); tipEl.textContent=rainy?'ğŸŒ§ å¤©æ°”ï¼šå°é›¨':'â˜€ï¸ å¤©æ°”ï¼šæ™´';
  maxCombo=0; coinsGot=0; diedAtLevel=1; firstSeen={coin:false,ice:false,shield:false,bomb:false}; safeBombsRun=0; freezesUsedRun=0;
  comboEl.textContent=''; rollMission(); updateMissionUI(); showFirstHint();
}
function startGame(){ reset(); state='play'; menuCard.style.display=''; lbCard.style.display='none'; achCard.style.display='none'; overlay.classList.remove('show'); if(!audioCtx) initAudio(); if(audioCtx.state==='suspended') audioCtx.resume(); startBGM(); }
function togglePause(){ if(state==='play'){ state='pause'; stopBGM(); overlay.classList.add('show'); msgEl.textContent='å·²æš‚åœï¼ˆç©ºæ ¼ç»§ç»­ï¼‰'; } else if(state==='pause'){ state='play'; overlay.classList.remove('show'); startBGM(); } }

/* ===== Update & Draw ===== */
let perfNow=0;
function update(dt){
  time+=dt; levelClock+=dt;
  if(invincible>0) invincible=Math.max(0,invincible-dt);
  if(dashing>0) dashing=Math.max(0,dashing-dt);
  if(dashCooldown>0) dashCooldown=Math.max(0,dashCooldown-dt);
  if(shield>0) shield=Math.max(0,shield-dt);
  if(freezeAll>0) freezeAll=Math.max(0,freezeAll-dt);
  blink-=dt; if(blink<=-rnd(2.5,4)) blink=0.18;
  if(combo>0){ comboTimer-=dt; if(comboTimer<=0){ combo=0; comboEl.textContent=''; } }

  if(levelClock>=LEVEL_LEN){ level++; levelClock=0; const rule=RULES[(level-2)%RULES.length]; setRule(rule); rollMission(); updateMissionUI(); }

  let move=0;
  if(keys.has('ArrowLeft')||keys.has('a')) move-=1;
  if(keys.has('ArrowRight')||keys.has('d')) move+=1;
  if(levelRule==='Reverse Controls') move=-move;
  if(pointerX!=null){ const dir=Math.sign(pointerX-dino.x); move=Math.abs(pointerX-dino.x)<4?0:dir; }
  if((keys.has('Shift')||keys.has('ShiftLeft')||keys.has('ShiftRight'))&&dashing<=0&&dashCooldown<=0){ dashing=DASH_DURATION; dashCooldown=DASH_COOLDOWN; sfxDash(); hideFirstHint(); }
  const spdMul=dashing>0?2.05:1.0; dino.vx=move*dino.speed*spdMul; dino.x+=dino.vx; dino.x=Math.max(40,Math.min(W-40,dino.x));

  spawnTimer-=dt; let interval=Math.max(0.18,0.9-time*0.02-Math.max(0,level-1)*0.02); if(levelRule==='Speed Up') interval*=0.8; if(spawnTimer<=0){ spawnFruit(); spawnTimer=interval; }
  powerTimer-=dt; coinTimer-=dt; bombTimer-=dt; iceTimer-=dt;
  if(powerTimer<=0){ if(Math.random()<0.45) spawnShield(); powerTimer=rnd(2.0,3.4); }
  if(iceTimer<=0||levelRule==='Ice Age'){ if(Math.random()<(levelRule==='Ice Age'?0.85:0.5)) spawnSnow(); iceTimer=rnd(3.0,5.0); }
  if(coinTimer<=0||levelRule==='Gold Rush'){ if(Math.random()<(levelRule==='Gold Rush'?0.92:0.6)) spawnCoin(); coinTimer=rnd(2.6,4.4); }
  if(bombTimer<=0||levelRule==='Bomb Storm'){ if(Math.random()<(levelRule==='Bomb Storm'?0.9:0.55)) spawnBomb(); bombTimer=rnd(2.2,3.8); }

  const slow=freezeAll>0?0.2:1; fruits.forEach(b=>b.y+=b.vy*slow); powers.forEach(p=>p.y+=p.vy*slow); coins.forEach(g=>g.y+=g.vy*slow); bombs.forEach(b=>b.y+=b.vy*slow);

  const before=fruits.length; fruits=fruits.filter(b=>b.y<=H+40); const removed=before-fruits.length; if(removed>0) addScore(removed);
  powers=powers.filter(p=>p.y<=H+40); coins=coins.filter(g=>g.y<=H+40); bombs=bombs.filter(b=>b.y<=H+40);

  for(let i=powers.length-1;i>=0;i--){ const p=powers[i]; if(hitBox(dino.x,dino.y,dino.w,dino.h,p.x+p.w/2,p.y+p.h/2,p.w,p.h,0.9)){ if(p.kind==='shield'){ shield+=SHIELD_GAIN; sfxShield(); splash(p.x+p.w/2,p.y+p.h/2,'#7dffa5'); if(!firstSeen.shield){ tip('ğŸ›¡ ç›¾ç‰Œï¼š5ç§’å…ç–«'); firstSeen.shield=true; } } if(p.kind==='ice'){ freezeAll=4.0; sfxIce(); splash(p.x+p.w/2,p.y+p.h/2,'#aee7ff'); freezesUsedRun++; if(freezesUsedRun>=5) unlockAch('freeze_5','ç´¯è®¡è§¦å‘ 5 æ¬¡å†°å†»'); if(!firstSeen.ice){ tip('â„ï¸ é›ªèŠ±ï¼šå…¨åœºå†»ç»“4s'); firstSeen.ice=true; } } powers.splice(i,1);} }
  for(let i=coins.length-1;i>=0;i--){ const g=coins[i]; if(hitBox(dino.x,dino.y,dino.w,dino.h,g.x+g.w/2,g.y+g.h/2,g.w,g.h,0.9)){ addScore(5,true); coinsGot++; coinsThisLevel++; coinCntEl.textContent=String(coinsGot); sfxCoin(); splash(g.x+g.w/2,g.y+g.h/2,'#ffd166'); if(!firstSeen.coin){ tip('ğŸª™ é‡‘å¸ï¼š+5 åˆ†'); firstSeen.coin=true; unlockAch('first_coin','ç¬¬ä¸€æ¬¡æ¡åˆ°é‡‘å¸'); } updateMissionUI(); tryFinishMission(); coins.splice(i,1);} }

  if(dashing>0){
    for(let i=fruits.length-1;i>=0;i--){ const b=fruits[i]; const bx=b.x+b.w/2,by=b.y+b.h/2; if(hitBox(dino.x,dino.y,dino.w,dino.h,bx,by,b.w,b.h,0.92)){ fruits.splice(i,1); combo+=1; comboTimer=COMBO_WINDOW; comboEl.textContent=`COMBO Ã—${combo}`; maxCombo=Math.max(maxCombo,combo); if(combo>=5) unlockAch('combo_5','æ‰“å‡º 5 è¿å‡»'); if(combo>=10) unlockAch('combo_10','æ‰“å‡º 10 è¿å‡»'); bestComboThisLevel=Math.max(bestComboThisLevel,combo); updateMissionUI(); tryFinishMission(); sfxCombo(combo); floatText(bx,by,`+${1*combo}`,'#aaf'); addScore(1*combo); splash(bx,by,'#9ad'); } }
    for(let i=bombs.length-1;i>=0;i--){ const b=bombs[i]; const bx=b.x+b.w/2,by=b.y+b.h/2; if(hitBox(dino.x,dino.y,dino.w,dino.h,bx,by,b.w,b.h,0.95)){ bombs.splice(i,1); sfxBomb(); splash(bx,by,'#ff9b6b',22); safeBombsRun++; if(safeBombsRun>=5) unlockAch('bombtech_5','ç´¯è®¡å®‰å…¨å¼•çˆ† 5 æšç‚¸å¼¹'); } }
  }

  if(invincible<=0 && dashing<=0){ for(let i=bombs.length-1;i>=0;i--){ const b=bombs[i]; const bx=b.x+b.w/2,by=b.y+b.h/2; if(hitBox(dino.x,dino.y,dino.w,dino.h,bx,by,b.w,b.h,0.85)){ bombs.splice(i,1); onHit(); sfxBomb(); splash(bx,by,'#ff6b6b',26); fruits=fruits.filter(f=>Math.hypot((f.x+f.w/2)-bx,(f.y+f.h/2)-by)>80); break; } } }
  if(invincible<=0 && shield<=0 && dashing<=0){ for(let b of fruits){ const bx=b.x+b.w/2,by=b.y+b.h/2; if(hitBox(dino.x,dino.y,dino.w,dino.h,bx,by,b.w,b.h,0.78)){ onHit(); break; } } }

  if(level>=5) unlockAch('level_5','åˆ°è¾¾å…³å¡ 5');
  if(level>=10) unlockAch('level_10','åˆ°è¾¾å…³å¡ 10');

  dashFill.style.width=`${(1-dashCooldown/DASH_COOLDOWN)*100}%`;
  shieldFill.style.width=`${Math.min(1,shield/SHIELD_GAIN)*100}%`;
}
function draw(){ pClear(); drawParallax(); if(rainy||levelRule==='Heavy Rain') drawRain(); drawParticles(); drawDino(); fruits.forEach(b=>b.type.draw(b)); powers.forEach(p=>p.kind==='shield'?drawShieldItem(p):drawSnow(p)); coins.forEach(g=>drawCoin(g)); bombs.forEach(b=>drawBomb(b)); pixRect(10,H-14,Math.min(1,time/30)*(W-20),4,'rgba(255,255,255,.3)'); drawFloatTexts(); if(freezeAll>0) pixRect(0,0,W,H,'rgba(120,180,255,0.10)'); }
function loop(ts){ if(!loop.last) loop.last=ts; const dt=Math.min(0.033,(ts-loop.last)/1000); loop.last=ts; perfNow=ts/1000; if(state==='play'){ update(dt); draw(); pPresent(); } else { pClear(); draw(); pPresent(); } requestAnimationFrame(loop); }

/* ===== Rain ===== */
let raindrops=[];
function initRain(){ raindrops=[]; for(let i=0;i<Math.max(100, Math.floor(W*H/9000)); i++){ raindrops.push({x:Math.random()*W,y:Math.random()*H,v:6+Math.random()*8}); } }
initRain();
function drawRain(){ for(let r of raindrops){ pixRect(r.x,r.y,2,10,'rgba(200,220,255,.25)'); r.x-=1.2; r.y+=r.v; if(r.y>H){ r.y=-10; r.x=Math.random()*W; } } }

/* ===== Collision / End ===== */
function hitBox(px,py,pw,ph,bx,by,bw,bh,k=1){ return Math.abs(px-bx)<(pw/2+bw/2)*k && Math.abs(py-by)<(ph/2+bh/2)*k; }
function onHit(){ if(shield>0){ shield=0; sfxHit(); splash(dino.x,dino.y-8,'#7dffa5',22); return; } lives-=1; renderLives(); sfxHit(); invincible=1.2; combo=0; comboEl.textContent=''; splash(dino.x,dino.y-8,'#ff6b6b',22); fruits=fruits.filter(b=>b.y<dino.y-50); if(lives<=0){ diedAtLevel=level; gameOver(); } }
function gameOver(){ state='dead'; stopBGM(); if(score>=best){ best=score; bestEl.textContent=best; localStorage.setItem('dino_highscore_v8',best); } showLeaderboard(true); }

/* ===== Level/Rule helpers ===== */
function setRule(rule){ levelRule=rule; if(rule==='Reverse Controls') tip('æ–¹å‘é”®å·²åå‘ï¼ˆè§¦æ§ä¸å˜ï¼‰'); if(rule==='Gold Rush') tip('é‡‘å¸æš´é›¨ï¼ğŸª™'); if(rule==='Ice Age') tip('â„ï¸ å†°å†»é“å…·é«˜å‘'); if(rule==='Bomb Storm') tip('ğŸ’£ ç‚¸å¼¹é«˜å‘'); if(rule==='Heavy Rain') tip('ğŸŒ§ å¤§é›¨æ¥è¢­'); if(rule==='Speed Up') tip('â© æ›´å¿«æ›´å¯†'); showBanner(`LEVEL ${level} Â· ${rule}`); }
function tip(t){ tipEl.textContent=t; setTimeout(()=>{ if(tipEl.textContent===t) tipEl.textContent=''; },2600); }

/* ===== First-time hints ===== */
function showFirstHint(){ if(!settings.hints) return; const isTouch='ontouchstart' in window; firstHintEl.style.display=''; firstHintEl.textContent=isTouch?'ğŸ‘‰ å·¦å³æ‹–æ‹½ç§»åŠ¨ï¼›å³ä¸Šè§’å¯æš‚åœ/é™éŸ³ã€‚':'â†/â†’ ç§»åŠ¨ Â· Shift å†²åˆº Â· ç©ºæ ¼æš‚åœ'; setTimeout(()=>{ if(firstHintEl.style.display!=='none') firstHintEl.style.display='none'; },8000); }
function hideFirstHint(){ settings.hints=false; saveSettings(); firstHintEl.style.display='none'; }

/* ===== è‡ªé€‚åº”ï¼šè®¡ç®—å¹¶è®¾ç½®ç”»å¸ƒå°ºå¯¸ ===== */
function onResize(){
  // å¯ç”¨åŒºåŸŸï¼ˆé¢„ç•™ HUD/è¾¹è·ï¼‰
  const vw=window.innerWidth, vh=window.innerHeight;
  const usableW = Math.max(360, vw - 32);       // å·¦å³è¾¹è·
  const usableH = Math.max(520, vh - 160);      // é¡¶éƒ¨ HUD+åº•éƒ¨æç¤ºé¢„ç•™
  const aspect = usableW/usableH;

  // è§„åˆ™ï¼šç«–å±å–æ›´å®½çš„çºµæ¨ªæ¯”ï¼›æ¨ªå±å°½é‡æ”¾å®½ï¼ˆåœºåœ°æ›´å¤§ï¼‰
  let targetW, targetH;
  if (aspect < 0.75) {                     // çª„ç«–å±ï¼ˆæ‰‹æœºï¼‰
    targetH = Math.min(usableH, 1200);
    targetW = Math.min(usableW, Math.round(targetH*0.68)); // æ¯”ä¹‹å‰æ›´å®½ï¼ˆ0.68ï¼‰
  } else if (aspect < 1.2) {               // å®½ç«–å± / å¹³æ¿ç›´ç«‹
    targetW = Math.min(usableW, 1200);
    targetH = Math.min(usableH, Math.round(targetW/0.75)); // W/Hâ‰ˆ0.75
  } else {                                  // æ¨ªå±ï¼šæ˜æ˜¾åŠ å®½
    targetW = Math.min(usableW, 1600);
    targetH = Math.min(usableH, Math.round(targetW/1.4));  // W/Hâ‰ˆ1.4
  }

  // åº”ç”¨å°ºå¯¸
  W = Math.max(420, Math.floor(targetW));
  H = Math.max(620, Math.floor(targetH));
  canvas.width = W; canvas.height = H;

  // é‡æ–°æ„å»ºåƒç´ ç”»å¸ƒå’Œé›¨æ»´ã€å¹¶å°†ç°æœ‰å…ƒç´ é™åˆ¶åœ¨æ–°è¾¹ç•Œå†…
  pInitCanvas(); initRain(); clampAll();
}
function clampAll(){
  dino.x = Math.max(40, Math.min(W-40, dino.x));
  fruits = fruits.filter(b=> b.x>=-60 && b.x<=W+60);
  powers = powers.filter(p=> p.x>=-60 && p.x<=W+60);
  coins  = coins.filter(g=> g.x>=-60 && g.x<=W+60);
  bombs  = bombs.filter(b=> b.x>=-60 && b.x<=W+60);
}
window.addEventListener('resize', ()=>{ onResize(); });
window.addEventListener('orientationchange', ()=>{ setTimeout(onResize, 100); });

/* ===== Boot ===== */
onResize();            // <<< åˆå§‹åŒ–æ—¶æ ¹æ®è®¾å¤‡å°ºå¯¸è®¾ç½®ç”»å¸ƒ
renderLives();
overlay.classList.add('show');
draw(); pPresent();
requestAnimationFrame(loop);
</script>
</body>
</html>
